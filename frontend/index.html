<!DOCTYPE html>
<html>
<head>
    <title>Trail Running Visualization</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/gpx.min.js"></script>
    <style>
        #map {
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // Create the Leaflet map
        const map = L.map('map').setView([0, 0], 13); // Initial view (will be updated)

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Load the GPX file and center the map
        const gpxFile = 'gpx/trail_route.gpx'; // The GPX file is served from the shared volume
        const gpxLayer = new L.GPX(gpxFile, {
            async: true, // Load the GPX file asynchronously
            marker_options: {
                startIconUrl: "./start.png", //'https://leafletjs.com/examples/custom-icons/leaf-green.png',
                endIconUrl: "./finish.png", //'https://leafletjs.com/examples/custom-icons/leaf-red.png',
                //shadowUrl: 'https://leafletjs.com/examples/custom-icons/leaf-shadow.png'
            }
        }).on('loaded', function(e) {
            // Fit the map to the bounds of the GPX route
            map.fitBounds(e.target.getBounds());
        }).addTo(map);

        // Dictionary to store markers for each athlete
        const athleteMarkers = {};

        // Connect to the WebSocket
        const socket = new WebSocket("ws://localhost:8000/ws");

        const maleIcon = L.icon({
            iconUrl: "male.png", //"https://leafletjs.com/examples/custom-icons/leaf-blue.png", // Replace with a blue icon
          //  shadowUrl: "https://leafletjs.com/examples/custom-icons/leaf-shadow.png",
            iconSize: [28, 65],
          //  shadowSize: [50, 64],
            iconAnchor: [12, 64],
          //  shadowAnchor: [4, 62],
            popupAnchor: [-3, -46]
        });

        const femaleIcon = L.icon({
            iconUrl: "female.png", //"https://leafletjs.com/examples/custom-icons/leaf-pink.png", // Replace with a pink icon
         //   shadowUrl: "https://leafletjs.com/examples/custom-icons/leaf-shadow.png",
            iconSize: [28, 65],
           // shadowSize: [50, 64],
            iconAnchor: [12, 64],
           // shadowAnchor: [4, 62],
            popupAnchor: [-3, -46]
        });

        socket.onmessage = function (event) {
            const data = JSON.parse(event.data);

            // Extract athlete data
            const athlete = data.athlete;
            const gender = data.gender; // Get the gender from the event
            const lat = data.location.latitude;
            const lon = data.location.longitude;
            
            // Choose the icon based on gender
            const icon = gender === "male" ? maleIcon : femaleIcon;

            console.log(`Updating marker for ${athlete} to [${lat}, ${lon}]`);
            // Check if a marker already exists for this athlete
            if (athlete in athleteMarkers) {
                // Update the position of the existing marker
                athleteMarkers[athlete].setLatLng([lat, lon]);
            } else {
                // Create a new marker for the athlete
                const marker = L.marker([lat, lon], {icon: icon})
                    /*icon: L.icon({
                        iconUrl: "./marker_black.png", //"https://leafletjs.com/examples/custom-icons/leaf-orange.png",
                        //shadowUrl: "https://leafletjs.com/examples/custom-icons/leaf-shadow.png",
                        iconSize: [38, 75], // size of the icon
                        //shadowSize: [50, 64], // size of the shadow
                        iconAnchor: [22, 74], // point of the icon which will correspond to marker's location
                        //shadowAnchor: [4, 62], // the same for the shadow
                        popupAnchor: [-3, -56], // point from which the popup should open relative to the iconAnchor
                    }),
                })*/
                    .addTo(map)
                    .bindPopup(`<b>${athlete}</b>`);

                // Store the marker in the dictionary
                athleteMarkers[athlete] = marker;
                
            }

            // Center the map on the athlete's position
            //map.setView([lat, lon], 15); // Adjust the zoom level as needed
        };
    </script>
</body>
</html>